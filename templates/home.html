{% extends "base_for_home.html" %}

{% block content %}
    {% load static %}
    <div class="row m-1">
        <div class="col-sm-7 col-md-6 col-lg-7" style="background-color:#E2D1B1;" id="vue-el-w">
            <div id="recipe-browser" class="h-100" style="display: none;">
                <span aria-hidden="true" style="position:absolute; top:0; right:20px;" v-on:click="toggleIframe()">&times;</span>
                <iframe name="recipe-frame" class="w-100 h-100" style="border:none;"></iframe>
            </div>
            <div id="left-list" class="h-100">
                <div class="row">
                    <div class="col-3">
                        <form v-on:submit.prevent="searchItems()" class="form-inline m-2">
                            <input
                                type="text"
                                class="form-control"
                                id="word"
                                placeholder="Search"
                                v-model="word">
                        </form>
                    </div>
                    <div class="col-1 d-flex align-items-end">
                        <span v-on:click="clearSearch()" style="color: #D38E6C">Clear</span>
                    </div>
                    <div class="col-8">
                        <span>Sort: </span>
                        <button type="button" class="btn btn-info m-2" v-on:click="switchSort('title')">Title</button>
                        <button type="button" class="btn btn-info m-2" v-on:click="switchSort('date')">Date</button>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="displayRadios" id="works-checkbox" value="works" checked="checked" v-model="display">
                          <label class="form-check-label" for="works-checkbox">Works</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="displayRadios" id="wish-list-checkbox" value="wish" v-model="display">
                          <label class="form-check-label" for="wish-list-checkbox">Wish List</label>
                        </div>
                    </div>
                </div>
                <div class="row" style="overflow-y: scroll; height: 580px;">
                    <div v-if="display == 'works'" class="col-md-4 col-sm-5 p-1" v-for="work in works" v-on:click="getWork(work.id)">
                        <div class="bg-white">
                            <div class="p-2">
                                <h4 class="text-center">${work.title}</h4>
                                <img v-bind:src="work.image" class="w-100">
                                <div class="text-right">${work.made_date}</div>
                            </div>
                        </div>
                    </div>
                    <div v-if="display == 'wish'" class="col-md-4 col-sm-5 p-1" v-for="wish in wishes" v-on:click="getWish(wish.id)">
                        <div class="bg-white">
                            <div class="p-2">
                                <h4 class="text-center">${wish.title}</h4>
                                <img v-bind:src="wish.image" class="w-100">
                                <div class="text-right">${wish.date_created}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        {% include 'snippets/works_modals.html' %}
        {% include 'snippets/wishlist_modals.html' %}


        </div>
        <div class="col-sm-5 col-md-6 col-lg-5" style="background-color:#FFF9EF;">
            <div id="vue-el-s">
            <div class="row">
                <form v-on:submit.prevent="searchIngredients(word)" class="form-inline m-2">
                    <input
                        type="text"
                        class="form-control"
                        id="word"
                        placeholder="Search"
                        v-model="word">
                </form>
                <div class=" d-flex align-items-end">
                        <span v-on:click="clearSearch()" style="color: #D38E6C">Clear</span>
                </div>
            </div>
            <div>
                <table class="table table-sm">
                    <thead style="display: block;">
                      <tr>
                        <th scope="col" v-on:click="switchSort('name')" style="width: 230px">Name</th>
                        <th scope="col" v-on:click="switchSort('expiration')" style="width: 200px">Expiration Date</th>
                        <th scope="col" style="width: 50px"></th>
                        <th scope="col" style="width: 50px"></th>
                      </tr>
                    </thead>
                    <tbody style="overflow-y: scroll; height: 250px; display: block;">
                        <tr v-for="ingredient in ingredients">
                            <td v-on:dblclick="getIngredient(ingredient.id, 'edit')" style="width: 230px;">${ingredient.name}</td>
                            <td v-on:dblclick="getIngredient(ingredient.id, 'edit')" style="width: 200px;"><span v-if="ingredient.expiration_date">${ingredient.expiration_date}</span></td>
                            <td style="width: 50px;">
                            {% load static %}
                            <img v-if="ingredient.is_expired" src='{% static "image/caution-mark.png" %}' alt="expired" class="float-left" height="23px" />
                            </td>
                            <td v-on:click="getIngredient(ingredient.id, 'delete')" class="text-secondary" style="width: 50px;">&times;</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        <!-- Edit Ingredient modal -->
        <div class="modal fade" id="edit-ingredient-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Edit Ingredient</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form v-on:submit.prevent="updateIngredient()" class="form-inline">
                <div class="modal-body">
                  <input
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="Enter name"
                    v-model="currentIngredient.name"
                    required="required" >
                  <input
                    type="date"
                    class="form-control"
                    id="expiration_date"
                    v-model="currentIngredient.expiration_date" >
                </div>
                <div class="modal-footer">
                <button type="submit" class="btn btn-primary" >Save changes</button>
                </div>
                </form>
              </div>
            </div>
           <div class="loading" v-if="loading===true">Loading&#8230;</div>
          </div>
        <!-- End of Edit Ingredient modal -->

        <!-- Delete Ingredient modal -->
        <div class="modal fade" id="delete-ingredient-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Delete Ingredient</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form v-on:submit.prevent="deleteIngredient()" class="form-inline">
                <div class="modal-body">
                  Are you sure to delete "${currentIngredient.name}"?
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary m-progress" data-dismiss="modal">No</button>
                <button type="submit" class="btn btn-primary" >Yes</button>
                </div>
                </form>
              </div>
            </div>
           <div class="loading" v-if="loading===true">Loading&#8230;</div>
          </div>
        <!-- End of Delete Ingredient modal -->
        </div>


     <div id="vue-el-l">
         <h5>Shopping List</h5>
        <form v-on:submit.prevent="addItem()" class="form-inline m-2">
            <input
                type="text"
                class="form-control"
                id="name"
                placeholder="Name"
                v-model="newItem.name"
                required="required">
            <input
                type="text"
                class="form-control"
                id="amount"
                placeholder="(Amount)"
                v-model="newItem.amount">
            <button type="submit" class="btn btn-dark ml-1">Add</button>
        </form>
         <table class="table table-sm">
            <thead style="display: block;">
              <tr>
                <th scope="col" style="width: 50px"></th>
                <th scope="col" style="width: 230px">Name</th>
                <th scope="col" style="width: 200px">Amount</th>
                <th scope="col" style="width: 50px"></th>
              </tr>
            </thead>
            <tbody style="overflow-y: scroll; height: 150px; display: block; width:100%;">
                <tr v-for="item in items">
                    <td style="width: 50px"><input type="checkbox" v-model="item.is_bought" v-on:click="checkItem(item.id)"></td>
                    <td v-on:dblclick="getItem(item.id, 'edit')" style="width: 230px">${item.name}</td>
                    <td v-on:dblclick="getItem(item.id, 'edit')" style="width: 200px"><span v-if="item.amount">${item.amount}</span></td>
                    <td v-on:click="getItem(item.id, 'delete')" class="text-secondary" style="width: 50px">&times;</td>
                </tr>
            </tbody>
         </table>


        <!-- Edit Item modal -->
        <div class="modal fade" id="edit-item-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Edit Item</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form v-on:submit.prevent="updateItem()" class="form-inline">
                <div class="modal-body">
                  <input
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="Name"
                    v-model="currentItem.name"
                    required="required" >
                  <input
                    type="text"
                    class="form-control"
                    id="amount"
                    placeholder="(Amount)"
                    v-model="currentItem.amount">
                </div>
                <div class="modal-footer">
                <button type="submit" class="btn btn-primary" >Save changes</button>
                </div>
                </form>
              </div>
            </div>
           <div class="loading" v-if="loading===true">Loading&#8230;</div>
          </div>
        <!-- End of Edit Item modal -->

        <!-- Delete Item modal -->
        <div class="modal fade" id="delete-item-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLongTitle">Delete Item</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form v-on:submit.prevent="deleteItem()" class="form-inline">
                <div class="modal-body">
                  Are you sure to delete "${currentItem.name}"?
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary m-progress" data-dismiss="modal">No</button>
                <button type="submit" class="btn btn-primary" >Yes</button>
                </div>
                </form>
              </div>
            </div>
           <div class="loading" v-if="loading===true">Loading&#8230;</div>
          </div>
        <!-- End of Delete Item modal -->
        </div>
     </div>
    </div>

{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
        axios.defaults.headers.common['X-CSRFToken'] = "{{ csrf_token }}";
        axios.defaults.headers.post['Content-Type'] = 'application/json';

        new Vue({
            el: '#vue-el-w',
            delimiters: ['${','}'],
            data: {
                display: "works",
                works: [],
                loading: false,
                currentWork: {},
                currentWork_recipes: [],
                currentWork_new_recipes: [],
                currentWork_image: null,
                newWork: { 'title': null, 'made_date': null, 'note': null, 'image': null },
                newWork_recipes: [{ 'work_id': null, 'link_title': "Recipe", 'url': null }],
                deleted_work_recipe: { 'work_id': null, 'link_title': "Recipe", 'url': null },
                workAPIUrls:{ 'titleA': '/api/works/t-a', 'titleD': '/api/works/t-d', 'dateA': '/api/works/d-a', 'dateD': '/api/works/d-d' },
                wishes: [],
                currentWish: {},
                currentWish_recipes: [],
                currentWish_new_recipes: [],
                currentWish_image: null,
                newWish: { 'title': null, 'note': null, 'image': null },
                newWish_recipes:[{ 'wish_id': null, 'link_title': "Recipe", 'url': null }],
                deleted_wish_recipe: { 'work_id': null, 'link_title': "Recipe", 'url': null },
                wishAPIUrls:{ 'titleA': '/api/wish-list/t-a', 'titleD': '/api/wish-list/t-d', 'dateA': '/api/wish-list/d-a', 'dateD': '/api/wish-list/d-d' },
                word: null,
                sortType: "dateD",
            },
            mounted: function() {
                this.getWorks();
                this.getWishes();
            },
            methods: {
                {% include 'snippets/works_methods.js' %}
                {% include 'snippets/wishlist_methods.js' %}

                getToday: function() {
                    const toTwoDigits = num => num < 10 ? '0' + num : num;
                    let today = new Date();
                    let year = today.getFullYear();
                    let month = toTwoDigits(today.getMonth() + 1);
                    let day = toTwoDigits(today.getDate());
                    return `${year}-${month}-${day}`;
                },
                searchWorks: function() {
                    this.loading = true;
                    axios.get(this.workAPIUrls[this.sortType] + '/?search=' + this.word)
                        .then((response) => {
                            this.works = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                searchWishes: function() {
                    this.loading = true;
                    axios.get(this.wishAPIUrls[this.sortType] + '/?search=' + this.word)
                        .then((response) => {
                            this.wishes = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                switchSort: function(button) {
                    this.loading = true;
                    if (button == "title") {
                        if (this.sortType == "titleA") {
                            this.sortType = "titleD"
                        } else {
                            this.sortType = "titleA"
                        }
                    } else if (button == "date") {
                        if (this.sortType == "dateA") {
                            this.sortType = "dateD"
                        } else {
                            this.sortType = "dateA"
                        }
                    }
                    if (this.display == "works") {
                        this.getWorks();
                    } else {
                        this.getWishes()
                    }
                },
                searchItems: function() {
                    if (this.display == "works") {
                        this.searchWorks();
                    } else {
                        this.searchWishes()
                    }
                },
                clearSearch: function() {
                    this.getWorks();
                    this.getWishes();
                    this.word = "";
                },
                toggleIframe: function () {
                    if (this.display == "works") {
                        $("#work-detail-modal").modal('toggle');
                    } else {
                        $("#wish-detail-modal").modal('toggle');
                    }
                    $('#recipe-browser').toggle();
                    $('#left-list').toggle();
                },
            }
        });
    </script>
    <script type="text/javascript">
        {% include 'snippets/storage.js' %}
    </script>
    <script>
        axios.defaults.headers.common['X-CSRFToken'] = "{{ csrf_token }}";
        axios.defaults.headers.post['Content-Type'] = 'application/json';

        new Vue({
            el: '#vue-el-l',
            delimiters: ['${', '}'],
            data: {
                items: [],
                currentItem: {},
                loading: false,
                newItem: { 'name' : null, 'amount' : null }
            },
            mounted: function () {
                this.getItems();
            },
            methods: {
                getItems: function () {
                    this.loading = true;
                    axios.get('/api/shopitem/')
                        .then((response) => {
                            this.items = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                getItem: function (id, action) {
                    this.loading = true;
                    axios.get(`/api/shopitem/${id}/`)
                        .then((response) => {
                            this.currentItem = response.data;
                            if (action == "edit") {
                                $("#edit-item-modal").modal('show');
                            } else if (action == "delete") {
                                $("#delete-item-modal").modal('show');
                            }
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                updateItem: function () {
                    this.loading = true;
                    axios.put(`/api/shopitem/${this.currentItem.id}/`, this.currentItem)
                        .then((response) => {
                            this.loading = false;
                            this.currentItem = response.data;
                            this.getItems();
                            $("#edit-item-modal").modal('toggle');
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                checkItem: function (id) {
                    axios.get(`/api/shopitem/${id}/`)
                        .then((response) => {
                            this.currentItem = response.data;
                            this.currentItem.is_bought = !this.currentItem.is_bought;
                            this.loading = false;
                            axios.put(`/api/shopitem/${this.currentItem.id}/`, this.currentItem)
                                .then((response) => {
                                    this.loading = false;
                                    this.currentItem = response.data;
                                    this.getItems();
                                })
                                .catch((err) => {
                                    this.loading = false;
                                    console.log(err);
                                })
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                deleteItem: function () {
                    this.loading = true;
                    axios.delete(`/api/shopitem/${this.currentItem.id}/`)
                        .then((response) => {
                            this.loading = false;
                            this.getItems();
                            $("#delete-item-modal").modal('toggle');
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                addItem: function () {
                    this.loading = true;
                    axios.post('/api/shopitem/', this.newItem)
                        .then((response) => {
                            this.loading = false;
                            this.getItems();
                            this.newItem.name = null;
                            this.newItem.amount = null;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                }
            }
        })
    </script>
    <script>
        $('.modal').on("hidden.bs.modal", function (e) {
            if ($('.modal:visible').length) {
                $('body').addClass('modal-open');
            }
        });
    </script>
{% endblock extra_js %}