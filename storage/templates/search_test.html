{% extends "base.html" %}

{% block extra_meta %}
    <meta name=”viewport” content=”width=device-width, initial-scale=1.0">
{% endblock extra_meta %}

{% block content %}
<div id="vue-el">
    <form v-on:submit.prevent="addIngredient()" class="form-inline m-2">
        <input
            type="text"
            class="form-control"
            id="name"
            placeholder="Name"
            v-model="newIngredient.name">

        <div class="form-group ml-2">
            <label for="expiration_date">Expiration Date: </label>
            <input
                type="date"
                class="form-control"
                id="expiration_date"
                v-model="newIngredient.expiration_date">
        </div>
        <button type="submit" class="btn btn-dark ml-1">Add</button>
    </form>
    <form v-on:submit.prevent="searchIngredients(word)" class="form-inline m-2">
        <input
            type="text"
            class="form-control"
            id="word"
            placeholder="Search"
            v-model="word">
    </form>
    <table class="table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Expiration Date</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody>
            <tr v-for="ingredient in ingredients">
                <td>${ingredient.name}</td>
                <td>${ingredient.expiration_date}</td>
                <td>
                {% load static %}
                <img v-if="ingredient.is_expired" src='{% static "image/caution-mark.png" %}' alt="expired" class="float-left" height="23px" />
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
        axios.defaults.headers.common['X-CSRFToken'] = "{{ csrf_token }}";
        axios.defaults.headers.post['Content-Type'] = 'application/json';

        new Vue({
            el: '#vue-el',
            delimiters: ['${','}'],
            data: {
                ingredients: [],
                loading: false,
                currentIngredient: {},
                message: null,
                word: null,
                newIngredient: { 'name': null, 'expiration_date': null },
            },
            mounted: function() {
                this.getIngredients();
            },
            methods: {
                getIngredients: function() {
                    this.loading = true;
                    axios.get('/api/storage/search/')
                        .then((response) => {
                            this.ingredients = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                searchIngredients: function(word) {
                    this.loading = true;
                    axios.get('/api/storage/search/?search=' + word)
                        .then((response) => {
                            this.ingredients = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                addIngredient: function() {
                    this.loading = true;
                    axios.post('/api/ingredient/', this.newIngredient)
                        .then((response) => {
                            this.loading = false;
                            this.getIngredients();
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
            }
        })
    </script>
{% endblock extra_js %}
