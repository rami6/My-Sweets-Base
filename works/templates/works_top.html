{% extends "base.html" %}

{% block content %}
    {% load static %}
    <div id="vue-el">
    <div class="row">
        <div class="col-11"></div>
        <div class="col-1">
            <input type="image" src='{% static "image/add-button.png" %}' class="add-button" data-toggle="modal" data-target="#add-work-modal"/>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3 col-sm-5 bg-white m-1" v-for="work in works" v-on:click="getWork(work.id)">
            <h4 class="text-center">${work.title}</h4>
            <img v-bind:src="work.image" class="w-100">
            <div class="text-right">${work.made_date}</div>
        </div>
    </div>

    <!-- Work detail Modal -->
    <div class="modal fade" id="detail-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">${currentWork.title}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <div class="container-fluid">
                <div class="row">
                  <div class="col-md-4"><img v-bind:src="currentWork.image" class="w-100 "></div>
                  <div class="col-md-8">
                    <div v-for="recipe in currentWork_recipes">
                        <a v-bind:href="recipe.url">${recipe.link_title}</a>
                    </div>
                    <div>${currentWork.made_date}</div>
                    <div>${currentWork.note}</div>
                  </div>
                </div>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger" v-on:click="deleteWork(currentWork.id)">Delete</button>
            <button type="button" class="btn btn-primary" v-on:click="getWork(currentWork.id)">Edit</button>
          </div>
        </div>
      </div>
    </div>
    <!-- End of Work detail Modal -->
        
    <!-- Add Work Modal -->
      <div class="modal fade" id="add-work-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">ADD Work</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form enctype="multipart/form-data" v-on:submit.prevent="addWork()">
            <div class="modal-body">
                <div class="form-group">
                  <label for="image">Image</label>
                  <input
                    type="file"
                    class="form-control"
                    id="image"
                    accept=".jpg, .jpeg, .png"
                    @change="processFile($event.target.files)">
                </div>
                <div class="form-group">
                  <label for="title">Title</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    placeholder="Enter title"
                    v-model="newWork.title"
                    required="required" >
                </div>
                <div class="form-group">
                  <label for="made_date">Date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="made_date"
                    v-model="newWork.made_date"
                    required="required">
                </div>
                <div class="form-group">
                  <label for="note">Note</label>
                  <textarea
                    class="form-control"
                    id="note"
                    placeholder="Enter Note"
                    v-model="newWork.note"
                    rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
            </form>
          </div>
        </div>
       <div class="loading" v-if="loading===true">Loading&#8230;</div>
      </div>
      <!-- End of Add Work modal -->
        <!-- Edit Work Modal -->
      <div class="modal fade" id="edit-work-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">EDIT Work</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form v-on:submit.prevent="updateWork()">
            <div class="modal-body">
                <div class="form-group">
                  <label for="image">Image</label>
                    <div>
                    <img v-bind:src="currentWork.image" class="w-25 mb-1">
                    </div>
                  <input
                    type="file"
                    class="form-control"
                    id="image"
                    accept=".jpg, .jpeg, .png"
                    @change="processFile($event)">
                </div>
                <div class="form-group">
                  <label for="title">Title</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    placeholder="Enter title"
                    v-model="currentWork.title"
                    required="required" >
                </div>
                <div class="form-group">
                  <label for="made_date">Date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="made_date"
                    v-model="currentWork.made_date">
                </div>
                <div class="form-group">
                  <label for="note">Note</label>
                  <textarea
                    class="form-control"
                    id="note"
                    placeholder="Enter Note"
                    v-model="currentWork.note"
                    rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
            </form>
          </div>
        </div>
       <div class="loading" v-if="loading===true">Loading&#8230;</div>
      </div>
    <!-- End of Edit Work modal -->


</div>
{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
        axios.defaults.headers.common['X-CSRFToken'] = "{{ csrf_token }}";
        axios.defaults.headers.post['Content-Type'] = 'application/json';

        new Vue({
            el: '#vue-el',
            delimiters: ['${','}'],
            data: {
                works: [],
                loading: false,
                currentWork: {},
                currentWork_recipes: [],
                newWork: { 'title': null, 'made_date': null, 'note': null, 'image': null },
            },
            mounted: function() {
                this.getWorks();
                this.setDefaultValue();
            },
            methods: {
                getWorks: function() {
                    this.loading = true;
                    axios.get('/api/work/')
                        .then((response) => {
                            this.works = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                getWork: function(id) {
                    this.loading = true;
                    axios.get(`/api/work/${id}/`)
                        .then((response) => {
                            this.currentWork = response.data;
                            this.getRecipe(id)
                            $("#detail-modal").modal('show');
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                getRecipe: function(work_id) {
                    this.loading = true;
                    axios.get('/api/works/recipe-by-work/' + work_id)
                        .then((response) => {
                            this.currentWork_recipes = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                addWork: function() {
                    let formData = new FormData();
                    formData.append("title", this.newWork.title)
                    if (this.newWork.image) {
                        formData.append("image", this.newWork.image)
                    }
                    formData.append("made_date", this.newWork.made_date)
                    formData.append("note", this.newWork.note)

                    this.loading = true;
                    axios.post('/api/work/', formData, {
                            headers: {
                              'Content-Type': 'multipart/form-data'
                            }
                        })
                        .then((response) => {
                            this.loading = false;
                            this.getWorks();
                            $("#add-work-modal").modal('toggle');
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                updateWork: function() {
                    this.loading = true;
                    axios.put(`/api/work/${this.currentWork.id}/`, this.currentWork)
                        .then((response) => {
                            this.loading = false;
                            this.currentWork = response.data;
                            this.getWorks();
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                deleteWork: function(id) {
                    this.loading = true;
                    axios.delete(`/api/work/${id}/`)
                        .then((response) => {
                            this.loading = false;
                            this.getWorks();
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                processFile: function(filelist) {
                    if (!filelist.length) return;
                    this.newWork.image = filelist[0];
                },
                getToday: function() {
                    const toTwoDigits = num => num < 10 ? '0' + num : num;
                    let today = new Date();
                    let year = today.getFullYear();
                    let month = toTwoDigits(today.getMonth() + 1);
                    let day = toTwoDigits(today.getDate());
                    return `${year}-${month}-${day}`;
                },
                setDefaultValue: function () {
                    this.newWork.made_date = this.getToday();
                }
            }
        });
    </script>
{% endblock extra_js %}