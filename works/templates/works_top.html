{% extends "base.html" %}

{% block content %}
    {% load static %}
    <div id="vue-el">
    <div class="row">
        <div class="col-11"></div>
        <div class="col-1">
            <input type="image" src='{% static "image/add-button.png" %}' class="add-button" data-toggle="modal" data-target="#add-work-modal"/>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3 col-sm-5 bg-white m-1" v-for="work in works" v-on:click="getWork(work.id)">
            <h4 class="text-center">${work.title}</h4>
            <img v-bind:src="work.image" class="w-100">
            <div class="text-right">${work.made_date}</div>
        </div>
    </div>

    <!-- Work detail Modal -->
    <div class="modal fade" id="work-detail-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">${currentWork.title}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <div class="container-fluid">
                <div class="row">
                  <div class="col-md-4"><img v-bind:src="currentWork.image" class="w-100 "></div>
                  <div class="col-md-8">
                    <div v-for="recipe in currentWork_recipes">
                        <a v-bind:href="recipe.url">${recipe.link_title}</a>
                    </div>
                    <div>${currentWork.made_date}</div>
                    <div>${currentWork.note}</div>
                  </div>
                </div>
              </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger" data-toggle="modal" data-target="#delete-work-modal">Delete</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" data-toggle="modal" v-on:click="openEditModal()">Edit</button>
          </div>
        </div>
      </div>
    </div>
    <!-- End of Work detail Modal -->
        
    <!-- Add Work Modal -->
      <div class="modal fade" id="add-work-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">ADD Work</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form enctype="multipart/form-data" v-on:submit.prevent="addWork()">
            <div class="modal-body">
                <div class="form-group">
                  <label for="image">Image</label>
                  <input
                    type="file"
                    class="form-control"
                    id="image"
                    accept=".jpg, .jpeg, .png"
                    @change="processFile($event.target.files, 'add')">
                </div>
                <div class="form-group">
                  <label for="title">Title</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    placeholder="Enter title"
                    v-model="newWork.title"
                    required="required" >
                </div>
                <div class="form-group">
                  <label for="made_date">Date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="made_date"
                    v-model="newWork.made_date"
                    required="required">
                </div>
                <div class="form-group">
                  <label for="title">Recipe URL</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    placeholder="Enter url"
                    v-model="newRecipe.url" >
                </div>
                <div class="form-group">
                  <label for="title">Recipe title</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    placeholder="Enter title"
                    v-model="newRecipe.link_title" >
                </div>
                <div class="form-group">
                  <label for="note">Note</label>
                  <textarea
                    class="form-control"
                    id="note"
                    placeholder="Enter Note"
                    v-model="newWork.note"
                    rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
            </form>
          </div>
        </div>
       <div class="loading" v-if="loading===true">Loading&#8230;</div>
      </div>
    <!-- End of Add Work modal -->

    <!-- Edit Work Modal -->
      <div class="modal fade" id="edit-work-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">EDIT Work</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form v-on:submit.prevent="updateWork()">
            <div class="modal-body">
                <div class="form-group">
                  <label for="image">Image</label>
                    <div>
                    <img v-bind:src="currentWork_image" class="w-25 mb-1">
                    </div>
                  <input
                    type="file"
                    class="form-control"
                    id="image"
                    accept=".jpg, .jpeg, .png"
                    @change="processFile($event.target.files, 'edit')">
                </div>
                <div class="form-group">
                  <label for="title">Title</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    placeholder="Enter title"
                    v-model="currentWork.title"
                    required="required" >
                </div>
                <div class="form-group">
                  <label for="made_date">Date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="made_date"
                    v-model="currentWork.made_date">
                </div>
                <div v-for="recipe in currentWork_recipes">
                    <div class="form-group">
                      <label for="title">Recipe URL</label>
                      <input
                        type="text"
                        class="form-control"
                        id="title"
                        placeholder="Enter url"
                        v-model="recipe.url" >
                    </div>
                    <div class="form-group">
                      <label for="title">Recipe title</label>
                      <input
                        type="text"
                        class="form-control"
                        id="title"
                        placeholder="Enter title"
                        v-model="recipe.link_title" >
                    </div>
                </div>
                <div class="form-group">
                  <label for="note">Note</label>
                  <textarea
                    class="form-control"
                    id="note"
                    placeholder="Enter Note"
                    v-model="currentWork.note"
                    rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
            </form>
          </div>
        </div>
       <div class="loading" v-if="loading===true">Loading&#8230;</div>
      </div>
    <!-- End of Edit Work modal -->

    <!-- Delete Work modal -->
    <div class="modal fade" id="delete-work-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">Delete Work</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form v-on:submit.prevent="deleteWork()" class="form-inline">
            <div class="modal-body">
              Are you sure to delete "${currentWork.title}"?
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary m-progress" data-dismiss="modal">No</button>
            <button type="submit" class="btn btn-primary">Yes</button>
            </div>
            </form>
          </div>
        </div>
       <div class="loading" v-if="loading===true">Loading&#8230;</div>
      </div>
    <!-- End of Delete Work modal -->

</div>
{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
        axios.defaults.headers.common['X-CSRFToken'] = "{{ csrf_token }}";
        axios.defaults.headers.post['Content-Type'] = 'application/json';

        new Vue({
            el: '#vue-el',
            delimiters: ['${','}'],
            data: {
                works: [],
                loading: false,
                currentWork: {},
                currentWork_recipes: [],
                currentWork_image: null,
                newWork: { 'title': null, 'made_date': null, 'note': null, 'image': null },
                newRecipe:{ 'work_id': null, 'link_title': "Recipe", 'url': null }
            },
            mounted: function() {
                this.getWorks();
                this.setDefaultValue();
            },
            methods: {
                getWorks: function() {
                    this.loading = true;
                    axios.get('/api/work/')
                        .then((response) => {
                            this.works = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                getWork: function(id) {
                    this.loading = true;
                    axios.get(`/api/work/${id}/`)
                        .then((response) => {
                            this.currentWork = response.data;
                            this.currentWork_image = response.data.image;
                            this.getRecipe(id);
                            $("#work-detail-modal").modal('show');
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                getRecipe: function(work_id) {
                    this.loading = true;
                    axios.get('/api/works/recipe-by-work/' + work_id)
                        .then((response) => {
                            this.currentWork_recipes = response.data;
                            this.loading = false;
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                addWork: function() {
                    let formData = new FormData();
                    formData.append("title", this.newWork.title);
                    if (this.newWork.image) {
                        formData.append("image", this.newWork.image);
                    }
                    formData.append("made_date", this.newWork.made_date);
                    formData.append("note", this.newWork.note);

                    this.loading = true;
                    axios.post('/api/work/', formData, {
                            headers: {
                              'Content-Type': 'multipart/form-data'
                            }
                        })
                        .then((response) => {
                            this.loading = false;
                            if (this.newRecipe.url) {
                                this.newRecipe.work_id = response.data.id;
                                this.addRecipe();
                            } else {
                                this.getWorks();
                            }
                            $("#add-work-modal").modal('toggle');
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                addRecipe: function() {
                    this.loading = true;
                    axios.post('/api/recipe/', this.newRecipe)
                        .then((response) => {
                            this.loading = false;
                            this.getWorks();
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                updateWork: function() {
                    let formData = new FormData();
                    formData.append("title", this.currentWork.title);
                    if (this.currentWork.image instanceof File) {
                        formData.append("image", this.currentWork.image);
                    }
                    formData.append("made_date", this.currentWork.made_date);
                    formData.append("note", this.currentWork.note);

                    this.loading = true;
                    axios.put(`/api/work/${this.currentWork.id}/`, formData, {
                            headers: {
                              'Content-Type': 'multipart/form-data'
                            }
                        })
                        .then((response) => {
                            this.loading = false;
                            this.currentWork = response.data;
                            this.updateRecipe();
                            $("#edit-work-modal").modal('toggle');
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                updateRecipe: function() {
                    this.loading = true;
                    this.currentWork_recipes.forEach(function(recipe) {
                        console.log(recipe);
                        console.log(recipe.work_id);
                        axios.put(`/api/recipe/${recipe.id}/`, recipe)
                        .then((response) => {
                            this.loading = false;
                            this.getWorks();
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                    });
                },
                deleteWork: function() {
                    this.loading = true;
                    axios.delete(`/api/work/${this.currentWork.id}/`)
                        .then((response) => {
                            this.loading = false;
                            this.getWorks();
                            $("#delete-work-modal").modal('toggle');
                            $("#work-detail-modal").modal('toggle');
                        })
                        .catch((err) => {
                            this.loading = false;
                            console.log(err);
                        })
                },
                processFile: function(filelist, action) {
                    if (!filelist.length) return;

                    if (action == "add") {
                        this.newWork.image = filelist[0];
                    } else if (action == "edit") {
                        this.currentWork.image = filelist[0];
                        const data = URL.createObjectURL(filelist[0]);
                        this.currentWork_image = data;
                    }
                },
                getToday: function() {
                    const toTwoDigits = num => num < 10 ? '0' + num : num;
                    let today = new Date();
                    let year = today.getFullYear();
                    let month = toTwoDigits(today.getMonth() + 1);
                    let day = toTwoDigits(today.getDate());
                    return `${year}-${month}-${day}`;
                },
                setDefaultValue: function () {
                    this.newWork.made_date = this.getToday();
                },
                openEditModal: function() {
                    $("#work-detail-modal").modal('toggle');
                },
            }
        });
    </script>
    <script>
        $('.modal').on("hidden.bs.modal", function (e) {
            if ($('.modal:visible').length) {
                $('body').addClass('modal-open');
            }
        });
    </script>
{% endblock extra_js %}